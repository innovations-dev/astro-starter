---
import type { HTMLAttributes } from "astro/types";
import { cva, type VariantProps } from "class-variance-authority";
import SelectTrigger from "./select-trigger.astro";
import SelectValue from "./select-value.astro";
import SelectContent from "./select-content.astro";
import SelectItem from "./select-item.astro";

interface Option {
  value: string;
  label: string;
}

interface Props extends HTMLAttributes<"div">, VariantProps<typeof selectVariants> {
  options: Option[];
  defaultValue?: string;
  name: string;
  label: string;
}

const selectVariants = cva("relative inline-block w-full", {
  variants: {
    size: {
      default: "",
      sm: "text-sm",
      lg: "text-lg"
    }
  },
  defaultVariants: {
    size: "default"
  }
});

const { options, defaultValue, name, label, size, class: className, ...rest } = Astro.props;

const id = `select-${name}`;
const listboxId = `listbox-${id}`;
---

<div class={selectVariants({ size, class: className })} {...rest} data-select>
  <label id={`${id}-label`} for={id} class="mb-1 block text-sm font-medium text-gray-700">
    {label}
  </label>
  <SelectTrigger
    id={id}
    data-select-trigger
    aria-haspopup="listbox"
    aria-expanded="false"
    aria-labelledby={`${id}-label`}
    class="flex w-full items-center justify-between rounded-md border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm hover:bg-gray-50 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"
  >
    <SelectValue data-select-value class="block truncate">
      {defaultValue ? options.find((opt) => opt.value === defaultValue)?.label : "Select an option"}
    </SelectValue>
    <span class="pointer-events-none ml-2" aria-hidden="true">
      <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path
          fill-rule="evenodd"
          d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
          clip-rule="evenodd"></path>
      </svg>
    </span>
  </SelectTrigger>
  <div class="relative">
    <SelectContent
      id={listboxId}
      data-select-content
      role="listbox"
      aria-labelledby={`${id}-label`}
      class="invisible absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-md border border-gray-300 bg-white opacity-0 shadow-lg transition-all duration-200 ease-in-out"
    >
      {
        options.map((option, index) => (
          <SelectItem
            value={option.value}
            data-select-item
            data-value={option.value}
            role="option"
            id={`${listboxId}-option-${index}`}
            aria-selected={option.value === defaultValue ? "true" : "false"}
            class="relative cursor-default select-none py-2 pl-3 pr-9 transition-colors duration-200 ease-in-out hover:bg-indigo-100 focus:bg-indigo-100 focus:outline-none"
            tabindex="-1"
          >
            {option.label}
          </SelectItem>
        ))
      }
    </SelectContent>
  </div>
  <select id={`${id}-native`} name={name} class="sr-only" data-select-native tabindex="-1" aria-hidden="true">
    <option value="" disabled selected={!defaultValue}>Select an option</option>
    {
      options.map((option) => (
        <option value={option.value} selected={option.value === defaultValue}>
          {option.label}
        </option>
      ))
    }
  </select>
</div>

<script>
  import { initializeSelects } from "./select-logic";
  document.addEventListener("DOMContentLoaded", initializeSelects);
</script>
